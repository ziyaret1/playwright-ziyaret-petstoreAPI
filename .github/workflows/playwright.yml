name: Playwright CI/CD Workflow

on:
    pull_request:
        branches: [main, ziyaret/newrules]
    schedule:
      - cron: '55 8 * * *'  # Runs daily at ___ AM 
    workflow_dispatch:
jobs:
    lint:
        name: ESLint Check
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install dependencies
              run: npm ci

            - name: Run ESLint
              run: npx eslint . --ext .ts,.tsx

    test:
        name: Playwright Tests (PR)
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install dependencies
              run: npm ci

            - name: Install Chromium only
              run: npx playwright install chromium

            - name: Run Playwright Tests (HTML + Allure + JUnit)
              run: npx playwright test --workers=1 --output=playwright-report || true
              env:
                  BASE_API: ${{ secrets.BASE_API }}

            - name: Install Allure CLI
              run: npm install -g allure-commandline --save-dev

            - name: Generate Allure Report
              if: always()
              run: allure generate ./allure-results --clean -o ./allure-report

            - name: Upload Playwright HTML Report as Artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-html-report-pr
                  path: playwright-report/**

            - name: Upload Allure Report as Artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: allure-report-pr
                  path: allure-report/**
            
            - name: Upload JUnit Results to QA Sphere
              if: always()
              run: |
                npm install -g qas-cli
                qasphere junit-upload \
                  --run-name "PR Test Run - {MMM} {DD}, {YYYY}, {hh}:{mm}:{ss} {AMPM}" \
                  --verbose \
                  test-results/junit-results.xml
              env:
                QAS_URL: ${{ secrets.QAS_URL }}
                QAS_TOKEN: ${{ secrets.QAS_TOKEN }}

    daily-regression:
        name: Daily Regression Tests
        runs-on: ubuntu-latest
        if: github.event_name == 'schedule'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install dependencies
              run: npm ci

            - name: Install Chromium only
              run: npx playwright install chromium

            - name: Run Playwright Tests (HTML + Allure + JUnit)
              run: npx playwright test --workers=1 --output=playwright-report || true
              env:
                  BASE_API: ${{ secrets.BASE_API }}

            - name: Install Allure CLI
              run: npm install -g allure-commandline --save-dev

            - name: Generate Allure Report
              if: always()
              run: allure generate ./allure-results --clean -o ./allure-report

            - name: Upload Playwright HTML Report as Artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-html-report-daily
                  path: playwright-report/**

            - name: Upload Allure Report as Artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: allure-report-daily
                  path: allure-report/**
            
            - name: Upload JUnit Results to QA Sphere
              if: always()
              run: |
                npm install -g qas-cli
                qasphere junit-upload \
                  --run-name "Daily Regression - {MMM} {DD}, {YYYY}, {hh}:{mm}:{ss} {AMPM}" \
                  --verbose \
                  test-results/junit-results.xml
              env:
                QAS_URL: ${{ secrets.QAS_URL }}
                QAS_TOKEN: ${{ secrets.QAS_TOKEN }}
              
    deploy:
        name: Deploy Reports
        runs-on: ubuntu-latest
        needs: [test, daily-regression]
        if: always()
        permissions:
            contents: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download PR Allure Report (if exists)
              continue-on-error: true
              uses: actions/download-artifact@v4
              with:
                  name: allure-report-pr
                  path: ./site/allure-report

            - name: Download PR Playwright Report (if exists)
              continue-on-error: true
              uses: actions/download-artifact@v4
              with:
                  name: playwright-html-report-pr
                  path: ./site/playwright-report

            - name: Download Daily Allure Report (if exists)
              continue-on-error: true
              uses: actions/download-artifact@v4
              with:
                  name: allure-report-daily
                  path: ./site/allure-report

            - name: Download Daily Playwright Report (if exists)
              continue-on-error: true
              uses: actions/download-artifact@v4
              with:
                  name: playwright-html-report-daily
                  path: ./site/playwright-report

            - name: Create index.html for reports
              run: |
                  mkdir -p ./site
                  echo '<!DOCTYPE html>' > ./site/index.html
                  echo '<html><head><meta charset="UTF-8"><title>Test Reports</title>' >> ./site/index.html
                  echo '<style>' >> ./site/index.html
                  echo 'body { font-family: "Segoe UI", Tahoma, sans-serif; background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: #fff; text-align: center; padding: 50px; }' >> ./site/index.html
                  echo 'h1 { font-size: 2.5rem; margin-bottom: 40px; }' >> ./site/index.html
                  echo 'ul { list-style: none; padding: 0; display: flex; justify-content: center; gap: 30px; }' >> ./site/index.html
                  echo 'a { display: inline-block; padding: 20px 40px; border-radius: 12px; background: #1e3c72; color: #fff; text-decoration: none; font-size: 18px; font-weight: bold; transition: all 0.3s ease; box-shadow: 0 8px 20px rgba(0,0,0,0.4); }' >> ./site/index.html
                  echo 'a:hover { background: #2a5298; transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.6); }' >> ./site/index.html
                  echo '</style>' >> ./site/index.html
                  echo '</head><body>' >> ./site/index.html
                  echo '<h1>ðŸ“Š Test Reports</h1>' >> ./site/index.html
                  echo '<ul>' >> ./site/index.html
                  echo '<li><a href="allure-report/index.html">ðŸš€ Allure Report</a></li>' >> ./site/index.html
                  echo '<li><a href="playwright-report/index.html">ðŸŽ­ Playwright HTML Report</a></li>' >> ./site/index.html
                  echo '<li><a href="https://nocompany-536.eu1.qasphere.com/project/TRA/run" target="_blank">ðŸ§ª QA Sphere Run Dashboard</a></li>' >> ./site/index.html
                  echo '</ul>' >> ./site/index.html
                  echo '</body></html>' >> ./site/index.html

            - name: Deploy Reports to GitHub Pages ðŸš€
              uses: peaceiris/actions-gh-pages@v4
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  publish_dir: ./site
                  keep_files: true
                  allow_empty_commit: true